<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.104.3"><meta name=description content="A workshop on building serverless apps with Python"><meta name=author content="Ivica Kolenkaš"><link rel=icon href=https://ivica-k.github.io/serverless_python_workshop/images/favicon.png type=image/png><title>4.4 Fixing 'Donor sign-up' tests :: Build serverless apps with Python</title><link href=https://ivica-k.github.io/serverless_python_workshop/css/nucleus.css rel=stylesheet><link href=https://ivica-k.github.io/serverless_python_workshop/css/fontawesome-all.min.css rel=stylesheet><link href=https://ivica-k.github.io/serverless_python_workshop/css/hybrid.css rel=stylesheet><link href=https://ivica-k.github.io/serverless_python_workshop/css/featherlight.min.css rel=stylesheet><link href=https://ivica-k.github.io/serverless_python_workshop/css/perfect-scrollbar.min.css rel=stylesheet><link href=https://ivica-k.github.io/serverless_python_workshop/css/auto-complete.css rel=stylesheet><link href=https://ivica-k.github.io/serverless_python_workshop/css/atom-one-dark-reasonable.css rel=stylesheet><link href=https://ivica-k.github.io/serverless_python_workshop/css/theme.css rel=stylesheet><link href=https://ivica-k.github.io/serverless_python_workshop/css/tabs.css rel=stylesheet><link href=https://ivica-k.github.io/serverless_python_workshop/css/hugo-theme.css rel=stylesheet><link href=https://ivica-k.github.io/serverless_python_workshop/css/theme-mine.css rel=stylesheet><script src=https://ivica-k.github.io/serverless_python_workshop/js/jquery-3.3.1.min.js></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style><link href=css/style.css rel=stylesheet></head><body data-url=https://ivica-k.github.io/serverless_python_workshop/60-improvements/400-donor-signup-test.html><nav id=sidebar><div id=header-wrapper><div id=header><p>Serverless &lt;3 Python</p></div></div><section id=homelinks><ul><li><a class=padding href=https://ivica-k.github.io/serverless_python_workshop/><i class='fas fa-home'></i> Home</a></li></ul></section><div class=highlightable><ul class=topics><li data-nav-id=/10-intro.html title=Intro class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/10-intro.html>Intro</a><ul><li data-nav-id=/10-intro/100-what-is-it.html title="What are we going to build?" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/10-intro/100-what-is-it.html>What are we going to build?</a></li><li data-nav-id=/10-intro/200-functional-requirements.html title="Functional requirements" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/10-intro/200-functional-requirements.html>Functional requirements</a></li><li data-nav-id=/10-intro/300-aws-services.html title="Choosing AWS services" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/10-intro/300-aws-services.html>Choosing AWS services</a></li><li data-nav-id=/10-intro/400-infrastructure.html title="Infrastructure management" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/10-intro/400-infrastructure.html>Infrastructure management</a></li></ul></li><li data-nav-id=/20-prerequisites.html title=Prerequisites class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/20-prerequisites.html>Prerequisites</a><ul><li data-nav-id=/20-prerequisites/100-setup.html title="Project setup" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/20-prerequisites/100-setup.html>Project setup</a></li><li data-nav-id=/20-prerequisites/400-software.html title="Other software" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/20-prerequisites/400-software.html>Other software</a></li></ul></li><li data-nav-id=/30-donor-signup.html title="1.0 Donor sign-up" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/30-donor-signup.html>1.0 Donor sign-up</a><ul><li data-nav-id=/30-donor-signup/100-first-function.html title="1.1 First function" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/30-donor-signup/100-first-function.html>1.1 First function</a></li><li data-nav-id=/30-donor-signup/200-aws-lambda-101.html title="1.2 AWS Lambda - 101" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/30-donor-signup/200-aws-lambda-101.html>1.2 AWS Lambda - 101</a></li><li data-nav-id=/30-donor-signup/300-donor-signup.html title="1.3 Donor sign-up" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/30-donor-signup/300-donor-signup.html>1.3 Donor sign-up</a></li><li data-nav-id=/30-donor-signup/500-testing.html title="1.4 Testing" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/30-donor-signup/500-testing.html>1.4 Testing</a></li><li data-nav-id=/30-donor-signup/600-logging.html title="1.5 Logging" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/30-donor-signup/600-logging.html>1.5 Logging</a></li><li data-nav-id=/30-donor-signup/700-progress-check.html title="1.6 Progress check" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/30-donor-signup/700-progress-check.html>1.6 Progress check</a></li></ul></li><li data-nav-id=/40-persisting-data.html title="2.0 Donor sign-up - persisting data" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/40-persisting-data.html>2.0 Donor sign-up - persisting data</a><ul><li data-nav-id=/40-persisting-data/100-persist-data.html title="2.1 Persisting data serverlessly" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/40-persisting-data/100-persist-data.html>2.1 Persisting data serverlessly</a></li><li data-nav-id=/40-persisting-data/200-dynamodb-101.html title="2.2 DynamoDB 101" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/40-persisting-data/200-dynamodb-101.html>2.2 DynamoDB 101</a></li><li data-nav-id=/40-persisting-data/300-dynamodb-create.html title="2.3 Infra - create our DynamoDB table" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/40-persisting-data/300-dynamodb-create.html>2.3 Infra - create our DynamoDB table</a></li><li data-nav-id=/40-persisting-data/400-donor-signup-db.html title="2.4 Persist the donor to DynamoDB" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/40-persisting-data/400-donor-signup-db.html>2.4 Persist the donor to DynamoDB</a></li><li data-nav-id=/40-persisting-data/500-donor-signup-env-vars.html title="2.5 Table name error" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/40-persisting-data/500-donor-signup-env-vars.html>2.5 Table name error</a></li><li data-nav-id=/40-persisting-data/600-donor-signup-permissions.html title="2.6 Permissions error" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/40-persisting-data/600-donor-signup-permissions.html>2.6 Permissions error</a></li><li data-nav-id=/40-persisting-data/700-persist-finally.html title="2.7 Persist the donor to DynamoDB - for real" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/40-persisting-data/700-persist-finally.html>2.7 Persist the donor to DynamoDB - for real</a></li><li data-nav-id=/40-persisting-data/800-progress-check.html title="2.8 Progress check" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/40-persisting-data/800-progress-check.html>2.8 Progress check</a></li></ul></li><li data-nav-id=/50-donation-event.html title="3.0 Donation event" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/50-donation-event.html>3.0 Donation event</a><ul><li data-nav-id=/50-donation-event/100-one-idea.html title="3.1 One idea..." class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/50-donation-event/100-one-idea.html>3.1 One idea...</a></li><li data-nav-id=/50-donation-event/200-drawing-board.html title="3.2 The drawing board" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/50-donation-event/200-drawing-board.html>3.2 The drawing board</a></li><li data-nav-id=/50-donation-event/300-single-table.html title="3.3 Coding single table design" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/50-donation-event/300-single-table.html>3.3 Coding single table design</a></li><li data-nav-id=/50-donation-event/400-progress-check.html title="3.4 Progress check" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/50-donation-event/400-progress-check.html>3.4 Progress check</a></li></ul></li><li data-nav-id=/60-improvements.html title="4.0 Improvements" class="dd-item
parent"><a href=https://ivica-k.github.io/serverless_python_workshop/60-improvements.html>4.0 Improvements</a><ul><li data-nav-id=/60-improvements/100-db-layer-refactor.html title="4.1 DB layer refactoring" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/60-improvements/100-db-layer-refactor.html>4.1 DB layer refactoring</a></li><li data-nav-id=/60-improvements/200-db-response.html title="4.2 DB response" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/60-improvements/200-db-response.html>4.2 DB response</a></li><li data-nav-id=/60-improvements/300-api-response.html title="4.3 API response" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/60-improvements/300-api-response.html>4.3 API response</a></li><li data-nav-id=/60-improvements/400-donor-signup-test.html title="4.4 Fixing 'Donor sign-up' tests" class="dd-item
active"><a href=https://ivica-k.github.io/serverless_python_workshop/60-improvements/400-donor-signup-test.html>4.4 Fixing 'Donor sign-up' tests</a></li><li data-nav-id=/60-improvements/500-donation-create-test.html title="4.5 Donation create test" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/60-improvements/500-donation-create-test.html>4.5 Donation create test</a></li><li data-nav-id=/60-improvements/600-lambda-layers.html title="4.6 Lambda Layers" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/60-improvements/600-lambda-layers.html>4.6 Lambda Layers</a></li><li data-nav-id=/60-improvements/700-progress-check.html title="4.7 Progress check" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/60-improvements/700-progress-check.html>4.7 Progress check</a></li></ul></li><li data-nav-id=/70-reading-data.html title="5.0 Reading data" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/70-reading-data.html>5.0 Reading data</a><ul><li data-nav-id=/70-reading-data/100-donors.html title="5.1 Get all donors" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/70-reading-data/100-donors.html>5.1 Get all donors</a></li><li data-nav-id=/70-reading-data/200-donations.html title="5.2 Get all donations" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/70-reading-data/200-donations.html>5.2 Get all donations</a></li><li data-nav-id=/70-reading-data/300-single-donor.html title="5.3 Get a single donor" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/70-reading-data/300-single-donor.html>5.3 Get a single donor</a></li><li data-nav-id=/70-reading-data/400-single-donation.html title="5.4 Get a single donation" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/70-reading-data/400-single-donation.html>5.4 Get a single donation</a></li><li data-nav-id=/70-reading-data/500-progress-check.html title="5.5 Progress check" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/70-reading-data/500-progress-check.html>5.5 Progress check</a></li></ul></li><li data-nav-id=/80-emailing-donors.html title="6.0 Emailing donors" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/80-emailing-donors.html>6.0 Emailing donors</a><ul><li data-nav-id=/80-emailing-donors/10-get-donors-from-city.html title="6.1 Get all donors from a city" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/80-emailing-donors/10-get-donors-from-city.html>6.1 Get all donors from a city</a></li><li data-nav-id=/80-emailing-donors/20-create-secondary-index.html title="6.2 Create a secondary index" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/80-emailing-donors/20-create-secondary-index.html>6.2 Create a secondary index</a></li><li data-nav-id=/80-emailing-donors/30-query-secondary-index.html title="6.3 Query a secondary index" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/80-emailing-donors/30-query-secondary-index.html>6.3 Query a secondary index</a></li><li data-nav-id=/80-emailing-donors/40-dynamodb-streams-101.html title="6.4 DynamoDB streams 101" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/80-emailing-donors/40-dynamodb-streams-101.html>6.4 DynamoDB streams 101</a></li><li data-nav-id=/80-emailing-donors/50-reading-stream-data.html title="6.5 Reading stream data" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/80-emailing-donors/50-reading-stream-data.html>6.5 Reading stream data</a></li><li data-nav-id=/80-emailing-donors/60-read-stream-permissions.html title="6.6 Read stream permissions" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/80-emailing-donors/60-read-stream-permissions.html>6.6 Read stream permissions</a></li><li data-nav-id=/80-emailing-donors/70-read-stream-with-permissions.html title="6.7 Reading stream data - for real" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/80-emailing-donors/70-read-stream-with-permissions.html>6.7 Reading stream data - for real</a></li><li data-nav-id=/80-emailing-donors/80-filtering-stream-data.html title="6.8 Filtering stream data" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/80-emailing-donors/80-filtering-stream-data.html>6.8 Filtering stream data</a></li><li data-nav-id=/80-emailing-donors/90-get-donors-from-city-real.html title="6.9 Get all donors from a city - for real" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/80-emailing-donors/90-get-donors-from-city-real.html>6.9 Get all donors from a city - for real</a></li><li data-nav-id=/80-emailing-donors/100-email-donors.html title="6.10 Email donors" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/80-emailing-donors/100-email-donors.html>6.10 Email donors</a></li><li data-nav-id=/80-emailing-donors/110-progress-check.html title="6.11 Progress check" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/80-emailing-donors/110-progress-check.html>6.11 Progress check</a></li></ul></li><li data-nav-id=/90-the-end.html title="The end" class=dd-item><a href=https://ivica-k.github.io/serverless_python_workshop/90-the-end.html>The end</a></li></ul><section id=footer><ul><li><a href=https://forms.gle/J5tkKYpqaSkE6vA4A target=_blank>Feedback form <i class="fab fa-comments"></i></a></li><li><a href=https://www.linkedin.com/in/ivica-kolenka%C5%A1-8b333895/ target=_blank>LinkedIn <i class="fab fa-linkedin"></i></a></li><li><a href=https://www.twitter.com/nekybrate target=_blank>Twitter <i class="fab fa-twitter"></i></a></li><li><a href=https://www.github.com/ivica-k target=_blank>Github <i class="fab fa-github"></i></a></li></ul></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span class=links><a href=https://ivica-k.github.io/serverless_python_workshop/>Build serverless apps with Python workshop</a> > <a href=https://ivica-k.github.io/serverless_python_workshop/60-improvements.html>4.0 Improvements</a> > 4.4 Fixing 'Donor sign-up' tests</span></div></div></div><div id=head-tags></div><div id=chapter><div id=body-inner><h1 id=fixing-donor-sign-up-tests>Fixing &lsquo;Donor sign-up&rsquo; tests</h1><p>Our &ldquo;Donor sign-up&rdquo; functionality was finished and working a long time ago, several breaks ago, actually. As the page on
<a href=../30-donor-signup/500-testing.html>testing</a> states, <em>if your code is working but you haven’t tested it, is it really
working?</em>.</p><p>Running <code>pytest tests</code> from within <code>savealife</code> reveals the ugly truth:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>        <span style=color:#75715e># ... SNIP ...</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>with</span> Client(app) <span style=color:#66d9ef>as</span> client:
</span></span><span style=display:flex><span>            response <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span>http<span style=color:#f92672>.</span>post(
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;/donor/signup&#34;</span>,
</span></span><span style=display:flex><span>                headers<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#34;Content-Type&#34;</span>: <span style=color:#e6db74>&#34;application/json&#34;</span>},
</span></span><span style=display:flex><span>                body<span style=color:#f92672>=</span>json<span style=color:#f92672>.</span>dumps(json_payload)
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;</span>           <span style=color:#66d9ef>assert</span> response<span style=color:#f92672>.</span>status_code <span style=color:#f92672>==</span> <span style=color:#ae81ff>200</span>
</span></span><span style=display:flex><span>E           <span style=color:#66d9ef>assert</span> <span style=color:#ae81ff>400</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>200</span>
</span></span><span style=display:flex><span>E            <span style=color:#f92672>+</span>  where <span style=color:#ae81ff>500</span> <span style=color:#f92672>=</span> <span style=color:#f92672>&lt;</span>chalice<span style=color:#f92672>.</span>test<span style=color:#f92672>.</span>HTTPResponse object at <span style=color:#ae81ff>0x7fc62f0a5930</span><span style=color:#f92672>&gt;.</span>status_code
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>tests<span style=color:#f92672>/</span>test_app<span style=color:#f92672>.</span>py:<span style=color:#ae81ff>22</span>: <span style=color:#a6e22e>AssertionError</span>
</span></span></code></pre></div><p>and looking at the traceback we see that a <code>ValueError</code> was raised:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>ivica<span style=color:#f92672>-</span>savealife <span style=color:#f92672>-</span> ERROR <span style=color:#f92672>-</span> Caught exception <span style=color:#66d9ef>for</span> path <span style=color:#f92672>/</span>donor<span style=color:#f92672>/</span>signup
</span></span><span style=display:flex><span>Traceback (most recent call last):
</span></span><span style=display:flex><span>  File <span style=color:#e6db74>&#34;~/serverless_workshop/venv/lib/python3.10/site-packages/chalice/app.py&#34;</span>, line <span style=color:#ae81ff>1752</span>, <span style=color:#f92672>in</span> _get_view_function_response
</span></span><span style=display:flex><span>    response <span style=color:#f92672>=</span> view_function(<span style=color:#f92672>**</span>function_args)
</span></span><span style=display:flex><span>  File <span style=color:#e6db74>&#34;~/serverless_workshop/savealife/app.py&#34;</span>, line <span style=color:#ae81ff>22</span>, <span style=color:#f92672>in</span> donor_signup
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> get_app_db()<span style=color:#f92672>.</span>donor_signup(body)
</span></span><span style=display:flex><span>  File <span style=color:#e6db74>&#34;~/serverless_workshop/savealife/chalicelib/db.py&#34;</span>, line <span style=color:#ae81ff>26</span>, <span style=color:#f92672>in</span> get_app_db
</span></span><span style=display:flex><span>    table<span style=color:#f92672>=</span>boto3<span style=color:#f92672>.</span>resource(<span style=color:#e6db74>&#34;dynamodb&#34;</span>)<span style=color:#f92672>.</span>Table(TABLE_NAME),
</span></span><span style=display:flex><span>    <span style=color:#75715e># ... SNIP ...</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;Required parameter </span><span style=color:#e6db74>{</span>identifier<span style=color:#e6db74>}</span><span style=color:#e6db74> not set&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>ValueError</span>: Required parameter name <span style=color:#f92672>not</span> set
</span></span></code></pre></div><p>Right about now would be a good time to fix it.</p><h2 id=valueerror-required-parameter-name-not-set>ValueError: Required parameter name not set</h2><p>If the error messages was formatted just a bit better it would make it more clear:</p><p><code>ValueError: Required parameter 'name' not set</code></p><p>Now it is much more clear that the NAME of the DynamoDB table was not set. And how are we setting it? Through an environment
variable.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> json
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#f92672>from</span> unittest <span style=color:#f92672>import</span> mock
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> chalice.test <span style=color:#f92672>import</span> Client
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#3c3d38><span>ENV <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#34;ENV&#34;</span>, <span style=color:#e6db74>&#34;dev&#34;</span>)
</span></span><span style=display:flex;background-color:#3c3d38><span>first_name <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#34;WORKSHOP_NAME&#34;</span>, <span style=color:#e6db74>&#34;ivica&#34;</span>)  <span style=color:#75715e># replace with your own name of course</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex;background-color:#3c3d38><span><span style=color:#a6e22e>@mock</span><span style=color:#f92672>.</span>patch<span style=color:#f92672>.</span>dict(os<span style=color:#f92672>.</span>environ, {<span style=color:#e6db74>&#34;TABLE_NAME&#34;</span>: <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>first_name<span style=color:#e6db74>}</span><span style=color:#e6db74>-savealife-</span><span style=color:#e6db74>{</span>ENV<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>})
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_donor_signup</span>():
</span></span><span style=display:flex;background-color:#3c3d38><span>    <span style=color:#f92672>from</span> app <span style=color:#f92672>import</span> app
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    json_payload <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;first_name&#34;</span>: <span style=color:#e6db74>&#34;ivica&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;city&#34;</span>: <span style=color:#e6db74>&#34;Amsterdam&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;A+&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;email&#34;</span>: <span style=color:#e6db74>&#34;ivica@server.com&#34;</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> Client(app) <span style=color:#66d9ef>as</span> client:
</span></span><span style=display:flex><span>        response <span style=color:#f92672>=</span> client<span style=color:#f92672>.</span>http<span style=color:#f92672>.</span>post(
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;/donor/signup&#34;</span>,
</span></span><span style=display:flex><span>            headers<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#34;Content-Type&#34;</span>: <span style=color:#e6db74>&#34;application/json&#34;</span>},
</span></span><span style=display:flex><span>            body<span style=color:#f92672>=</span>json<span style=color:#f92672>.</span>dumps(json_payload),
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>assert</span> response<span style=color:#f92672>.</span>status_code <span style=color:#f92672>==</span> <span style=color:#ae81ff>200</span>
</span></span><span style=display:flex;background-color:#3c3d38><span>        <span style=color:#66d9ef>assert</span> response<span style=color:#f92672>.</span>json_body<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#34;success&#34;</span>)</span></span></code></pre></div><p>We changed quite a bit in the test so let&rsquo;s go through the changes one by one:</p><ol><li>Four changed lines in the beginning are imports and variables setup. Nothing we haven&rsquo;t seen so far.</li><li><code>@mock.patch</code> line is where the first half of the magic happens: that is where we&rsquo;re setting the value of the <code>TABLE_NAME</code>
variable</li><li>You probably noticed that the <code>from app import app</code> moved inside the function. We had to do it that way since
<code>@mock.patch</code> must happen before the <code>TABLE_NAME</code> environment variable is read in <code>chalicelib/db.py</code></li><li>The second <code>assert</code> statement was changed to expect a successful operation</li></ol><p>It will work :)</p><div class="notices info"><p>Real DynamoDB table was used. Instead of emulating the cloud for our tests we embraced the cloud and used real resources.
If you, for whatever reason, prefer to use local resources the possibility is there with <a href=https://github.com/localstack/localstack target=_blank>LocalStack</a>.
Not every AWS service is supported but DynamoDB is supported quite well.</p></div><h4 id=localstack>LocalStack</h4><p>This workshop will not focus on setting up LocalStack or tests that use it. If you wish to do so you may need to:</p><ol><li>Have <code>docker-compose</code> to run LocalStack on your machine</li><li>Change the code in <code>chalicelib/db.py</code> slightly so that the line <code>boto3.resource("dynamodb").Table(TABLE_NAME)</code> becomes
<code>boto3.resource("dynamodb", endpoint_url=LOCALSTACK_DYNAMO_ENDPOINT_HERE).Table(TABLE_NAME)</code></li></ol><footer class=footline></footer></div></div></div><div id=navigation><a class="nav nav-prev" href=https://ivica-k.github.io/serverless_python_workshop/60-improvements/300-api-response.html title="4.3 API response"><i class="fa fa-chevron-left"></i></a>
<a class="nav nav-next" href=https://ivica-k.github.io/serverless_python_workshop/60-improvements/500-donation-create-test.html title="4.5 Donation create test" style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=https://ivica-k.github.io/serverless_python_workshop/js/clipboard.min.js></script>
<script src=https://ivica-k.github.io/serverless_python_workshop/js/perfect-scrollbar.min.js></script>
<script src=https://ivica-k.github.io/serverless_python_workshop/js/perfect-scrollbar.jquery.min.js></script>
<script src=https://ivica-k.github.io/serverless_python_workshop/js/jquery.sticky.js></script>
<script src=https://ivica-k.github.io/serverless_python_workshop/js/featherlight.min.js></script>
<script src=https://ivica-k.github.io/serverless_python_workshop/js/highlight.pack.js></script>
<script>hljs.initHighlightingOnLoad()</script><script src=https://ivica-k.github.io/serverless_python_workshop/js/modernizr.custom-3.6.0.js></script>
<script src=https://ivica-k.github.io/serverless_python_workshop/js/learn.js></script>
<script src=https://ivica-k.github.io/serverless_python_workshop/js/hugo-learn.js></script>
<script src=https://ivica-k.github.io/serverless_python_workshop/mermaid/mermaid.js></script>
<script>mermaid.initialize({startOnLoad:!0})</script></body></html>